###                                                                                      分布式调度

含义：

1. 运行在分布式集群环境下的调度任务（同一个定时任务程序部署多份，只应该有一个定时任务在执行）
2. 分布式调度一>定时任务的分布式一>定时任务的拆分（即为把一个大的作业任务拆分为多个小的作
    任务，同时执行)

![image-20201010142035844](https://gitee.com/adc123321/blog_img/raw/master/image/202010/10/142035-855334.png)

定时任务和消息队列的区别

1. 共同点：

   异步处理
   比如注册、下单事件
  应用解耦
  不管定时任务作业还是MQ都可以作为两个应用之间的齿轮实现应用解耦，这个齿轮可以中转
 数据，当然单体服务不需要考虑这些，服务拆分的时候往往都会考虑
  流量削峰
  双十一的时候，任务作业和MQ都可以用来扛流量，后端系统根据服务能力定时处理订单或者
  从MQ抓取订单抓取到一个订单到来事件的话触发处理，对于前端用户来说看到的结果是已经
 单成功了，下单是不受任何影响的。

2. 本质不同
    定时任务作业是时间驱动，而MQ是事件驱动
    时间驱动是不可代替的，比如金融系统每日的利息结算，不是说利息来一条（利息到来事件）就算
    而往往是通过定时任务批量计算
    所以，定时任务作业更倾向于批处理，MQ傾向于逐条处理

分布式调度框架 Elastic-Job

**Elastic-Job是当当网在2015年开源的一个分布式调度解决方案，由两个相互独立的子项目Elastic-Job-Lite和Elastic-Job-Cloud组成。在这里，主要对Elastic-Job-Lite技术做分析**

![null](https://sdkfiledl.jiguang.cn/community/30070/image/Fth9FI4AGb7sTTp-guuGbsRCsf3H.png)

如上图所示，elastic-job-lite通过zk实现各服务的注册、控制及协调：

- 第一台服务器上线触发主服务器选举。主服务器一旦下线，则重新触发选举，选举过程中阻塞，只有主服务器选举完成，才会执行其他任务。
- 某服务节点(引入elastic-job-lite-jar包)上线时会自动将服务器信息注册到注册中心，下线时会自动更新服务器状态。
- 主节点选举，服务器上下线，分片总数变更均更新重新分片标记。
- 定时任务触发时，如需重新分片，则通过主服务器分片，分片过程中阻塞，分片结束后才可执行任务。如分片过程中主服务器下线，则先选举主服务器，再分片。
- 通过上一项说明可知，为了维持作业运行时的稳定性，运行过程中只会标记分片状态，不会重新分片。分片仅可能发生在下次任务触发前。
- 每次分片都会按服务器IP排序，保证分片结果不会产生较大波动。
- 实现失效转移功能，在某台服务器执行完毕后主动抓取未分配的分片，并且在某台服务器下线后主动寻找可用的服务器执行任务

## 调度问题的复杂性

- 弹性扩容
  每个业务服务节点同时也是一个定时任务执行者, 各任务执行者之间不会直接通信，而是通过zookeeper协调, 定时任务状态存储在zk, 去中心化部署。
  因此可以很方便地增加或者减少服务节点。
- 失效转移
  如果在任务执行过程中有一个执行实例挂了，那么之前被分配到这个实例的任务（或者分片）会在下次任务执行之前被重新分配到其他正常节点实例上执行。

- 任务分片
  elastic-job-lite并不直接提供数据处理的功能，框架只会将分片项分配至各个运行中的服务节点，开发者需要自行处理分片项与真实数据的对应关系。